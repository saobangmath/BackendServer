{% extends 'base.html' %}

{% block body %}
<br>
<section class="home-about-area section-gap">
<div class = "container">
  <h2>Questions</h2> <br>
  <p>Click on each individual attempt to view the statistics or to edit them.</p>
  <table class="table">
    <thead class="thead-light" style = "border-radius: 10px;">
      <tr>
        <th scope="col">LevelId</th>
        <th scope="col">Score</th>
        <th scope="col">Time</th>
        <th scope="col">UserId</th>
      </tr>
    </thead>
    <tbody id = "attempts_content">

    </tbody>
  </table>

</div>
</section>


<!-- Modal -->
<div class="modal fade" id="attemptsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered" role="document">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="exampleModalLongTitle">Question Details</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <h6>Question Statistics</h6>
    <p id ="attemptStats"></p>
    <h6>Edit Attempt</h6>
    LevelId: <input id = "levelIdEdit" class="form-control" type="text" placeholder="Default input">
    Score: <input id = "scoreEdit" class="form-control" type="text" placeholder="Default input">
    Time: <input id = "timeEdit" class="form-control" type="text" placeholder="Default input">
    UserId: <input id = "userIdEdit" class="form-control" type="text" placeholder="Default input">
  </div>
  <h6 id = "changesText" style = "display:none; text-align: center; color: green;">Changes saved!</h6>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    <button id = "saveButton" value = "" type="button" class="btn btn-primary" onclick = "saveAttempt(this.value)">Save changes</button>
  </div>
</div>
</div>
</div>

<!-- Modal -->
<div class="modal fade" id="attemptsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered" role="document">
<div class="modal-content">
  <div class="modal-header">
    <h5 class="modal-title" id="exampleModalLongTitle">Add Question</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <h6>Edit Attempt</h6>
    LevelId: <input id = "levelIdAdd" class="form-control" type="text" placeholder="Default input">
    Score: <input id = "scoreAdd" class="form-control" type="text" placeholder="Default input">
    Time: <input id = "timeAdd" class="form-control" type="text" placeholder="Default input">
    UserId: <input id = "userIdAdd" class="form-control" type="text" placeholder="Default input">
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    <button id = "saveButton" value = "" type="button" class="btn btn-primary" onclick = "saveAttempt(this.value)">Save changes</button>
  </div>
</div>
</div>
</div>
{% endblock %}

{% block script %}
<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyCbrmnFV_4UBbmFyJIhqIM_J5QDbpGkgRo",
    authDomain: "marvellous-kittens.firebaseapp.com",
    databaseURL: "https://marvellous-kittens.firebaseio.com",
    projectId: "marvellous-kittens",
    storageBucket: "marvellous-kittens.appspot.com",
    messagingSenderId: "942471948637",
    appId: "1:942471948637:web:29eec0236cd1e64d18e0b4"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  var database = firebase.database();

  var tbody = document.getElementById("attempts_content");

  // Initialise table
  database.ref('Attempts').on('value', function(snapshot) {
    tbody.innerHTML = "";
    snapshot.forEach(function(attempt) {
      var tr = document.createElement("tr");

      tr.setAttribute("class", "dataRow");
      tr.setAttribute("id", attempt.key);
      tr.setAttribute("data-toggle", "modal");
      tr.setAttribute("data-target", "#attemptModal");
      tr.setAttribute("onClick", "setAttemptModal(this.id)")

      var td1 = document.createElement("td");
      td1.innerHTML = attempt.val().levelId;
      var td2 = document.createElement("td");
      td2.innerHTML = attempt.val().score;
      var td3 = document.createElement("td");
      td3.innerHTML = attempt.val().time;
      var td4 = document.createElement("td");
      td4.innerHTML = attempt.val().userId;

      tr.appendChild(td1);
      tr.appendChild(td2);
      tr.appendChild(td3);
      tr.appendChild(td4);
      tbody.appendChild(tr);
    })
  });

  function setAttemptModal(id) {
    document.getElementById("changesText").style.display = "none";
    var content = document.getElementById("attemptStats");
    database.ref('Attempts/' + id).once('value', function(snapshot) {

      var levelIdEdit = document.getElementById("levelIdEdit");
      var scoreEdit = document.getElementById("scoreEdit");
      var timeEdit = document.getElementById("timeEdit");
      var userIdEdit = document.getElementById("userEdit");

      levelIdEdit.setAttribute("value", snapshot.val().levelId);
      scoreEdit.setAttribute("value", snapshot.val().score);
      timeEdit.setAttribute("value", snapshot.val().time);
      userIdEdit.setAttribute("value", snapshot.val().userId);

      document.getElementById("saveButton").setAttribute("value", id);
    })
  };

  function saveAttempt(id) {
    console.log(id);

    var levelIdEdit = document.getElementById("levelIdEdit").value;
    var scoreEdit = document.getElementById("scoreEdit").value;
    var timeEdit = document.getElementById("timeEdit").value;
    var userIdEdit = document.getElementById("userIdEdit").value;

    database.ref("Attempts/").child(id).update({
        levelId: levelIdEdit,
        score: scoreEdit,
        time: timeEdit,
        userId: userIdEdit,
      })
      document.getElementById("changesText").style.display = "block";

    }

</script>
{% endblock %}

{% block style %}
<style>
  .dataRow:hover {
    background-color:#dddddd;
  }
  .table {
    border-radius: 20px;
  }
</style>
{% endblock %}
<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <title>Attempts</title>
  </head>
  <body>

    <div class = "container" style = "padding: 50px;">
      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col">LevelId</th>
            <th scope="col">Score</th>
            <th scope="col">Time</th>
            <th scope="col">UserId</th>
          </tr>
        </thead>
        <tbody id = "questions_content">

        </tbody>
      </table>
      <div class = "col text-center">
        <button class = "btn btn-primary" style = "margin: auto;">Add Attempt</button>
      </div>
    </div>

<!-- Modal -->
<div class="modal fade" id="attemptModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Attempt Details</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h6>Attempts Statistics</h6>
        <p id ="attemptStats"></p>
        <h6>Edit Attempt</h6>
            LevelId: <input id = "levelIdEdit" class="form-control" type="text" placeholder="Default input">
            Score: <input id = "scoreEdit" class="form-control" type="text" placeholder="Default input">
            Time: <input id = "timeEdit" class="form-control" type="text" placeholder="Default input">
            UserId: <input id = "userIdEdit" class="form-control" type="text" placeholder="Default input">
      </div>
      <h6 id = "changesText" style = "display:none; text-align: center; color: green;">Changes saved!</h6>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button id = "saveButton" value = "" type="button" class="btn btn-primary" onclick = "saveAttempt(this.value)">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="questionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Add Attempt</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h6>Edit Attempt</h6>
        LevelId: <input id = "levelIdAdd" class="form-control" type="text" placeholder="Default input">
        Score: <input id = "scoreAdd" class="form-control" type="text" placeholder="Default input">
        Time: <input id = "timeAdd" class="form-control" type="text" placeholder="Default input">
        UserId: <input id = "userIdAdd" class="form-control" type="text" placeholder="Default input">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button id = "saveButton" value = "" type="button" class="btn btn-primary" onclick = "saveAttempt(this.value)">Save changes</button>
      </div>
    </div>
  </div>
</div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.9.1/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/7.9.1/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.9.1/firebase-database.js"></script>
    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyCbrmnFV_4UBbmFyJIhqIM_J5QDbpGkgRo",
        authDomain: "marvellous-kittens.firebaseapp.com",
        databaseURL: "https://marvellous-kittens.firebaseio.com",
        projectId: "marvellous-kittens",
        storageBucket: "marvellous-kittens.appspot.com",
        messagingSenderId: "942471948637",
        appId: "1:942471948637:web:29eec0236cd1e64d18e0b4"
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      var database = firebase.database();

      var tbody = document.getElementById("attempts_content");

      // Initialise table
      database.ref('Questions').on('value', function(snapshot) {
        tbody.innerHTML = "";
        snapshot.forEach(function(qn) {
          var tr = document.createElement("tr");
          tr.setAttribute("class", "dataRow");
          tr.setAttribute("id", attempt.key);
          tr.setAttribute("data-toggle", "modal");
          tr.setAttribute("data-target", "#attemptModal");
          tr.setAttribute("onClick", "setAttemptModal(this.id)")

          var td1 = document.createElement("td");
          td1.innerHTML = attempt.val().levelId;
          var td2 = document.createElement("td");
          td2.innerHTML = attempt.val().score;
          var td3 = document.createElement("td");
          td3.innerHTML = attempt.val().time;
          var td4 = document.createElement("td");
          td4.innerHTML = attempt.val().userId;

          tr.appendChild(td1);
          tr.appendChild(td2);
          tr.appendChild(td3);
          tr.appendChild(td4);
          tbody.appendChild(tr);
        })
      });

      function setQuestionModal(id) {
        document.getElementById("changesText").style.display = "none";
        var content = document.getElementById("questionStats");
        database.ref('Attempts/' + id).once('value', function(snapshot) {
          console.log(snapshot.val());

          var levelIdEdit = document.getElementById("levelIdEdit");
          var scoreEdit = document.getElementById("scoreEdit");
          var timeEdit = document.getElementById("timeEdit");
          var userIdEdit = document.getElementById("userIdEdit");

          levelIdEdit.setAttribute("value", snapshot.val().levelId);
          scoreEdit.setAttribute("value", snapshot.val().score);
          timeEdit.setAttribute("value", snapshot.val().time);
          userIdEdit.setAttribute("value", snapshot.val().userId);

          document.getElementById("saveButton").setAttribute("value", id);
        })
      };

      function saveAttempt(id) {
        console.log(id);

        var levelIdEdit = document.getElementById("levelIdEdit").value;
        var scoreEdit = document.getElementById("scoreEdit").value;
        var timeEdit = document.getElementById("timeEdit").value;
        var userIdEdit = document.getElementById("userIdEdit").value;

        database.ref("Attempts/").child(id).update({
            levelId: levelIdEdit,
            score: scoreEdit,
            time: timeEdit,
            user: userIdEdit,
          })
          document.getElementById("changesText").style.display = "block";
        }

    </script>
  </body>

</html>